<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyrhythm Generator</title>
    <script src="midiwriter.js"></script>
</head>
<body>
    <h1>Polyrhythm Generator</h1>
    
    <form id="polyrhythmForm">
        <h3>Global Settings</h3>
        <label for="tempo">Tempo (BPM):</label>
        <input type="number" id="tempo" name="tempo" value="120" min="1" max="300" required>
        <label for="duration">Duration (seconds):</label>
        <input type="number" id="duration" name="duration" value="30" min="1" max="600" required>
        <button type="submit" onclick="generateMidi()">Download MIDI</button>
        <button type="button" onclick="addNote()">Add Note</button>
        <div id="noteInputs"></div> <!-- Container for dynamic note inputs -->
    </form>

    <script>
        function addNote() {
            const container = document.getElementById('noteInputs');
            const noteIndex = container.children.length + 1;
            const noteDiv = document.createElement('div');
            noteDiv.id = 'noteContainer' + noteIndex;
            noteDiv.innerHTML = `
                <label for="note${noteIndex}">Note</label>
                <select id="note${noteIndex}" name="note${noteIndex}">
                    <option value="63">D#5</option>
                    <option value="55">G3</option>
                    <option value="69">A4</option>
                    <!-- Add other notes as needed -->
                </select>
                <label for="duration${noteIndex}">of duration</label>
                <input type="number" id="duration${noteIndex}" name="duration${noteIndex}" min="1" max="32" value="1" required>
                <label for="times${noteIndex}">must play</label>
                <input type="number" id="times${noteIndex}" name="times${noteIndex}" min="1" max="100" required>
                <label for="beats${noteIndex}">times within</label>
                <input type="number" id="beats${noteIndex}" name="beats${noteIndex}" min="1" max="100" value="20" required>
                
                <label for="xbut${noteIndex}">beats</label>
                <button type="button" id="xbut${noteIndex}" onclick="removeNote(${noteIndex})">Remove Note</button>
            `;
            container.appendChild(noteDiv);
        }

        function removeNote(index) {
            const noteToRemove = document.getElementById('noteContainer' + index);
            noteToRemove.remove();
        }

        function generateMidi() {
            var track = new MidiWriter.Track();
            const tempo = document.getElementById('tempo').value;
            const duration = document.getElementById('duration').value;
            track.setTempo(tempo);

            const notes = document.querySelectorAll('[id^="noteContainer"]');
            notes.forEach(noteContainer => {
                let note = noteContainer.querySelector('select').value;
                let times = parseInt(noteContainer.querySelector('[id^="times"]').value);
                let beats = parseInt(noteContainer.querySelector('[id^="beats"]').value);
                let noteDuration = parseInt(noteContainer.querySelector('[id^="duration"]').value);

                for (let i = 0; i < times; i++) {
                    track.addEvent(new MidiWriter.NoteEvent({pitch: [note], duration: `T${noteDuration}`, wait: `T${beats}`}), function(event, index) {
                        return {sequential:true};
                    });
                }
            });

            var write = new MidiWriter.Writer([track]);
            var dataUri = write.dataUri();
            downloadMidi(dataUri);
        }

        function downloadMidi(dataUri) {
            var link = document.createElement('a');
            link.href = dataUri;
            link.download = 'polyrhythm.mid';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>

