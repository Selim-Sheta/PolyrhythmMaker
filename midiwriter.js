// Minified version of MidiWriterJS:
// https://github.com/grimmdude/MidiWriterJS/blob/master/browser/midiwriter.js
// The official CDN is currently blocked by CORB on chrome so this is a workaround.
var MidiWriter=function(){"use strict";var t={VERSION:"3.1.1",HEADER_CHUNK_TYPE:[77,84,104,100],HEADER_CHUNK_LENGTH:[0,0,0,6],HEADER_CHUNK_FORMAT0:[0,0],HEADER_CHUNK_FORMAT1:[0,1],HEADER_CHUNK_DIVISION:[0,128],TRACK_CHUNK_TYPE:[77,84,114,107],META_EVENT_ID:255,META_SMTPE_OFFSET:84},e=(t,e)=>Array(Math.abs(e)+1).join(t),n=[0,2,4,-1,1,3,5],i=n.map(t=>Math.floor(7*t/12)),r={empty:!0,name:"",pc:"",acc:""},a=new Map,o=t=>"CDEFGAB".charAt(t),s=t=>t<0?e("b",-t):e("#",t),c=t=>"b"===t[0]?-t.length:t.length,h=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/,u=(t,e)=>(t%e+e)%e,l=[0,2,4,5,7,9,11];function d(t){var e;if(+(e=t)>=0&&127>=+e)return+t;let d=function t(e){var d,$;let f=JSON.stringify(e),p=a.get(f);if(p)return p;let v="string"==typeof e?function t(e){let a=function t(e){let n=h.exec(e);return[n[1].toUpperCase(),n[2].replace(/x/g,"##"),n[3],n[4]]}(e);if(""===a[0]||""!==a[3])return r;let o=a[0],s=a[1],d=a[2],$=(o.charCodeAt(0)+3)%7,f=c(s),p=d.length?+d:void 0,v=function t(e){let{step:r,alt:a,oct:o,dir:s=1}=e,c=n[r]+7*a;if(void 0===o)return[s*c];let h=o-i[r]-4*a;return[s*c,s*h]}({step:$,alt:f,oct:p}),E=(l[$]+f+120)%12,g=void 0===p?u(l[$]+f,12)-1188:l[$]+f+12*(p+1);return{empty:!1,acc:s,alt:f,chroma:E,coord:v,freq:void 0===p?null:440*Math.pow(2,(g-69)/12),height:g,letter:o,midi:g>=0&&g<=127?g:null,name:o+s+d,oct:p,pc:o+s,step:$}}(e):null!==(d=e)&&"object"==typeof d&&"number"==typeof d.step&&"number"==typeof d.alt?t(function t(e){let{step:n,alt:i,oct:r}=e,a=o(n);if(!a)return"";let c=a+s(i);return r||0===r?c+r:c}(e)):null!==($=e)&&"object"==typeof $&&"string"==typeof $.name?t(e.name):r;return a.set(f,v),v}(t);return d.empty?null:d.midi}var $=function(){function e(){}return e.version=function(){return t.VERSION},e.stringToBytes=function(t){return t.split("").map(function(t){return t.charCodeAt(0)})},e.isNumeric=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},e.getPitch=function(t,e){return void 0===e&&(e="C4"),60-d(e)+d(t)},e.numberToVariableLength=function(t){for(var e=127&(t=Math.round(t));t>>=7;)e<<=8,e|=127&t|128;for(var n=[];;)if(n.push(255&e),128&e)e>>=8;else break;return n},e.stringByteCount=function(t){return encodeURI(t).split(/%..|./).length-1},e.numberFromBytes=function(t){var e,n="";return t.forEach(function(t){1==(e=t.toString(16)).length&&(e="0"+e),n+=e}),parseInt(n,16)},e.numberToBytes=function(t,e){e=e||1;var n=t.toString(16);1&n.length&&(n="0"+n);var i=n.match(/.{2}/g).map(function(t){return parseInt(t,16)});if(i.length<e)for(;e-i.length>0;)i.unshift(0);return i},e.toArray=function(t){return Array.isArray(t)?t:[t]},e.convertVelocity=function(t){return Math.round((t=t>100?100:t)/100*127)},e.getTickDuration=function(n){if(Array.isArray(n))return n.map(function(t){return e.getTickDuration(t)}).reduce(function(t,e){return t+e},0);if("t"===(n=n.toString()).toLowerCase().charAt(0)){var i=parseInt(n.substring(1));if(isNaN(i)||i<0)throw Error(n+" is not a valid duration.");return i}var r=e.numberFromBytes(t.HEADER_CHUNK_DIVISION)*e.getDurationMultiplier(n);return e.getRoundedIfClose(r)},e.getRoundedIfClose=function(t){var e=Math.round(t);return 1e-6>Math.abs(e-t)?e:t},e.getPrecisionLoss=function(t){return Math.round(t)-t},e.getDurationMultiplier=function(t){if("0"===t)return 0;var e=t.match(/^(?<dotted>d+)?(?<base>\d+)(?:t(?<tuplet>\d*))?/);if(e){var n=Number(e.groups.base);if(1===n||(n&n-1)==0){var i,r=1/(n/4),a=e.groups,o=a.dotted,s=a.tuplet;if(o){var c=Math.pow(2,o.length);r+=r*((c-1)/c)}if("string"==typeof s){r=2*r/Number(s||"3")}return r}}throw Error(t+" is not a valid duration.")},e}(),f=function t(e){this.channel=e.channel-1||0,this.controllerValue=e.controllerValue,this.controllerNumber=e.controllerNumber,this.delta=e.delta||0,this.name="ControllerChangeEvent",this.status=176,this.data=$.numberToVariableLength(e.delta).concat(this.status|this.channel,this.controllerNumber,this.controllerValue)},p=function e(n){this.delta=n.delta||0,this.name="CopyrightEvent",this.text=n.text,this.type=2;var i=$.stringToBytes(this.text);this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type,$.numberToVariableLength(i.length),i)},v=function e(n){this.delta=n.delta||0,this.name="CuePointEvent",this.text=n.text,this.type=7;var i=$.stringToBytes(this.text);this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type,$.numberToVariableLength(i.length),i)},E=function e(n){this.delta=(null==n?void 0:n.delta)||0,this.name="EndTrackEvent",this.type=[47,0],this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type)},g=function e(n){this.delta=n.delta||0,this.name="InstrumentNameEvent",this.text=n.text,this.type=4;var i=$.stringToBytes(this.text);this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type,$.numberToVariableLength(i.length),i)},y=function e(n,i){this.name="KeySignatureEvent",this.type=89;var r=i||0;if(n=n||0,void 0===i){var a=n.length,o=n||"C";if(n[0]===n[0].toLowerCase()&&(r=1),a>1)switch(n.charAt(a-1)){case"m":case"-":r=1,o=(o=n.charAt(0).toLowerCase()).concat(n.substring(1,a-1));break;case"M":case"+":r=0,o=(o=n.charAt(0).toUpperCase()).concat(n.substring(1,a-1))}var s=[["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"],["ab","eb","bb","f","c","g","d","a","e","b","f#","c#","g#","d#","a#"]][r].indexOf(o);n=-1===s?0:s-7}this.data=$.numberToVariableLength(0).concat(t.META_EVENT_ID,this.type,[2],$.numberToBytes(n,1),$.numberToBytes(r,1))},b=function e(n){this.delta=n.delta||0,this.name="LyricEvent",this.text=n.text,this.type=5;var i=$.stringToBytes(this.text);this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type,$.numberToVariableLength(i.length),i)},m=function e(n){this.delta=n.delta||0,this.name="MarkerEvent",this.text=n.text,this.type=6;var i=$.stringToBytes(this.text);this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type,$.numberToVariableLength(i.length),i)},T=function(){function t(t){this.name="NoteOnEvent",this.channel=t.channel||1,this.pitch=t.pitch,this.wait=t.wait||0,this.velocity=t.velocity||50,this.tick=t.tick||null,this.delta=null,this.data=t.data,this.status=144}return t.prototype.buildData=function(t,e,n){return void 0===n&&(n={}),this.data=[],this.tick?(this.tick=$.getRoundedIfClose(this.tick),0==t.tickPointer&&(this.delta=this.tick)):(this.delta=$.getTickDuration(this.wait),this.tick=$.getRoundedIfClose(t.tickPointer+this.delta)),this.deltaWithPrecisionCorrection=$.getRoundedIfClose(this.delta-e),this.data=$.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,$.getPitch(this.pitch,n.middleC),$.convertVelocity(this.velocity)),this},t}(),x=function(){function t(t){this.name="NoteOffEvent",this.channel=t.channel||1,this.pitch=t.pitch,this.velocity=t.velocity||50,this.tick=t.tick||null,this.data=t.data,this.delta=t.delta||$.getTickDuration(t.duration),this.status=128}return t.prototype.buildData=function(t,e,n){return void 0===n&&(n={}),null===this.tick&&(this.tick=$.getRoundedIfClose(this.delta+t.tickPointer)),this.deltaWithPrecisionCorrection=$.getRoundedIfClose(this.delta-e),this.data=$.numberToVariableLength(this.deltaWithPrecisionCorrection).concat(this.status|this.channel-1,$.getPitch(this.pitch,n.middleC),$.convertVelocity(this.velocity)),this},t}(),_=function(){function t(t){this.data=[],this.name="NoteEvent",this.pitch=$.toArray(t.pitch),this.channel=t.channel||1,this.duration=t.duration||"4",this.grace=t.grace,this.repeat=t.repeat||1,this.sequential=t.sequential||!1,this.tick=t.startTick||t.tick||null,this.velocity=t.velocity||50,this.wait=t.wait||0,this.tickDuration=$.getTickDuration(this.duration),this.restDuration=$.getTickDuration(this.wait),this.events=[]}return t.prototype.buildData=function(){var e=this;if(this.data=[],this.grace&&(this.grace=$.toArray(this.grace),this.grace.forEach(function(){var n=new t({pitch:e.grace,duration:"T1"});e.data=e.data.concat(n.data)})),this.sequential)for(var n=0;n<this.repeat;n++)this.pitch.forEach(function(t,n){var i=new T({channel:e.channel,wait:n>0?0:e.wait,delta:n>0?0:$.getTickDuration(e.wait),velocity:e.velocity,pitch:t,tick:e.tick}),r=new x({channel:e.channel,duration:e.duration,velocity:e.velocity,pitch:t});e.events.push(i,r)});else for(var n=0;n<this.repeat;n++)this.pitch.forEach(function(t,n){var i;i=new T(0==n?{channel:e.channel,wait:e.wait,delta:$.getTickDuration(e.wait),velocity:e.velocity,pitch:t,tick:e.tick}:{channel:e.channel,wait:0,delta:0,velocity:e.velocity,pitch:t,tick:e.tick}),e.events.push(i)}),this.pitch.forEach(function(t,n){var i;i=new x(0==n?{channel:e.channel,duration:e.duration,velocity:e.velocity,pitch:t,tick:null!==e.tick?$.getTickDuration(e.duration)+e.tick:null}:{channel:e.channel,duration:0,velocity:e.velocity,pitch:t,tick:null!==e.tick?$.getTickDuration(e.duration)+e.tick:null}),e.events.push(i)});return this},t}(),k=function(){function t(t){this.channel=t.channel||0,this.delta=t.delta||0,this.name="PitchBendEvent",this.status=224;var e=this.scale14bits(t.bend);this.data=$.numberToVariableLength(this.delta).concat(this.status|this.channel,127&e,e>>7&127)}return t.prototype.scale14bits=function(t){return t<=0?Math.floor(16384*(t+1)/2):Math.floor(16383*(t+1)/2)},t}(),C=function e(n){this.bpm=n.bpm,this.delta=n.delta||0,this.tick=n.tick,this.name="TempoEvent",this.type=81;var i=Math.round(6e7/this.bpm);this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type,[3],$.numberToBytes(i,3))},D=function e(n){this.delta=n.delta||0,this.text=n.text,this.name="TextEvent",this.type=1;var i=$.stringToBytes(this.text);this.data=$.numberToVariableLength(n.delta).concat(t.META_EVENT_ID,this.type,$.numberToVariableLength(i.length),i)},w=function e(n,i,r,a){this.name="TimeSignatureEvent",this.type=88,this.data=$.numberToVariableLength(0).concat(t.META_EVENT_ID,this.type,[4],$.numberToBytes(n,1),$.numberToBytes(Math.log2(i),1),$.numberToBytes(r||24,1),$.numberToBytes(a||8,1))},A=function e(n){this.delta=n.delta||0,this.name="TrackNameEvent",this.text=n.text,this.type=3;var i=$.stringToBytes(this.text);this.data=$.numberToVariableLength(this.delta).concat(t.META_EVENT_ID,this.type,$.numberToVariableLength(i.length),i)},V=function(){function e(){this.type=t.TRACK_CHUNK_TYPE,this.data=[],this.size=[],this.events=[],this.explicitTickEvents=[],this.tickPointer=0}return e.prototype.addEvent=function(t,e){var n=this;return $.toArray(t).forEach(function(t,i){if(t instanceof _){if("function"==typeof e){var r=e(i,t);"object"==typeof r&&Object.assign(t,r)}null!==t.tick?n.explicitTickEvents.push(t):t.buildData().events.forEach(function(t){return n.events.push(t)})}else n.events.push(t)}),this},e.prototype.buildData=function(t){var e=this;void 0===t&&(t={}),this.data=[],this.size=[],this.tickPointer=0;var n=0;return this.events.forEach(function(i){if(i instanceof T||i instanceof x){var r=i.buildData(e,n,t);n=$.getPrecisionLoss(i.deltaWithPrecisionCorrection||0),e.data=e.data.concat(r.data),e.tickPointer=$.getRoundedIfClose(i.tick)}else i instanceof C&&(e.tickPointer=$.getRoundedIfClose(i.tick)),e.data=e.data.concat(i.data)}),this.mergeExplicitTickEvents(),this.events.length&&this.events[this.events.length-1]instanceof E||(this.data=this.data.concat((new E).data)),this.size=$.numberToBytes(this.data.length,4),this},e.prototype.mergeExplicitTickEvents=function(){var t=this;this.explicitTickEvents.length&&(this.explicitTickEvents.sort(function(t,e){return t.tick-e.tick}),this.explicitTickEvents.forEach(function(e){e.buildData().events.forEach(function(e){return e.buildData(t)}),e.events.forEach(function(e){return t.mergeSingleEvent(e)})}),this.explicitTickEvents=[],this.buildData())},e.prototype.mergeTrack=function(t){var e=this;return this.buildData(),t.buildData().events.forEach(function(t){return e.mergeSingleEvent(t)}),this},e.prototype.mergeSingleEvent=function(t){if(!this.events.length){this.addEvent(t);return}for(var e,n=0;n<this.events.length&&!(this.events[n].tick>t.tick);n++)e=n;var i=e+1;t.delta=t.tick-this.events[e].tick,this.events.splice(i,0,t);for(var n=i+1;n<this.events.length;n++)this.events[n].delta=this.events[n].tick-this.events[n-1].tick},e.prototype.removeEventsByName=function(t){var e=this;return this.events.forEach(function(n,i){n.name===t&&e.events.splice(i,1)}),this},e.prototype.setTempo=function(t,e){return void 0===e&&(e=0),this.addEvent(new C({bpm:t,tick:e}))},e.prototype.setTimeSignature=function(t,e,n,i){return this.addEvent(new w(t,e,n,i))},e.prototype.setKeySignature=function(t,e){return this.addEvent(new y(t,e))},e.prototype.addText=function(t){return this.addEvent(new D({text:t}))},e.prototype.addCopyright=function(t){return this.addEvent(new p({text:t}))},e.prototype.addTrackName=function(t){return this.addEvent(new A({text:t}))},e.prototype.addInstrumentName=function(t){return this.addEvent(new g({text:t}))},e.prototype.addMarker=function(t){return this.addEvent(new m({text:t}))},e.prototype.addCuePoint=function(t){return this.addEvent(new v({text:t}))},e.prototype.addLyric=function(t){return this.addEvent(new b({text:t}))},e.prototype.polyModeOn=function(){var t=new T({data:[0,176,126,0]});return this.addEvent(t)},e.prototype.setPitchBend=function(t){return this.addEvent(new k({bend:t}))},e.prototype.controllerChange=function(t,e,n,i){return this.addEvent(new f({controllerNumber:t,controllerValue:e,channel:n,delta:i}))},e}(),N=function(){function t(){}return t.prototype.trackFromVoice=function(t,e){var n=this;void 0===e&&(e={addRenderedAccidentals:!1});var i=new V,r=[];return t.tickables.forEach(function(t){"n"===t.noteType?(i.addEvent(new _({pitch:t.keys.map(function(i,r){return n.convertPitch(i,r,t,e.addRenderedAccidentals)}),duration:n.convertDuration(t),wait:r})),r=[]):"r"===t.noteType&&r.push(n.convertDuration(t))}),r.length>0&&i.addEvent(new _({pitch:"[c4]",duration:"0",wait:r,velocity:"0"})),i},t.prototype.convertPitch=function(t,e,n,i){void 0===i&&(i=!1);var r,a=t.split("/"),o=a[0].substring(1).replace("n","");return i&&(null===(r=n.getAccidentals())||void 0===r||r.forEach(function(t){t.index===e&&("n"===t.type?o="":o+=t.type)})),a[0][0]+o+a[1]},t.prototype.convertDuration=function(t){return"d".repeat(t.dots)+this.convertBaseDuration(t.duration)+(t.tuplet?"t"+t.tuplet.num_notes:"")},t.prototype.convertBaseDuration=function(t){switch(t){case"w":return"1";case"h":return"2";case"q":return"4";default:return t}},t}(),I=function e(n){this.type=t.HEADER_CHUNK_TYPE;var i=n>1?t.HEADER_CHUNK_FORMAT1:t.HEADER_CHUNK_FORMAT0;this.data=i.concat($.numberToBytes(n,2),t.HEADER_CHUNK_DIVISION),this.size=[0,0,0,this.data.length]},L=function(){function t(t,e){void 0===e&&(e={}),this.tracks=$.toArray(t),this.options=e}return t.prototype.buildData=function(){var t=this,e=[];return e.push(new I(this.tracks.length)),this.tracks.forEach(function(n){e.push(n.buildData(t.options))}),e},t.prototype.buildFile=function(){var t=[];return this.buildData().forEach(function(e){return t=t.concat(e.type,e.size,e.data)}),new Uint8Array(t)},t.prototype.base64=function(){if("function"==typeof btoa){for(var t="",e=this.buildFile(),n=e.byteLength,i=0;i<n;i++)t+=String.fromCharCode(e[i]);return btoa(t)}return Buffer.from(this.buildFile()).toString("base64")},t.prototype.dataUri=function(){return"data:audio/midi;base64,"+this.base64()},t.prototype.setOption=function(t,e){return this.options[t]=e,this},t.prototype.stdout=function(){return process.stdout.write(Buffer.from(this.buildFile()))},t}();return{Constants:t,ControllerChangeEvent:f,CopyrightEvent:p,CuePointEvent:v,EndTrackEvent:E,InstrumentNameEvent:g,KeySignatureEvent:y,LyricEvent:b,MarkerEvent:m,NoteOnEvent:T,NoteOffEvent:x,NoteEvent:_,PitchBendEvent:k,ProgramChangeEvent:function t(e){this.channel=e.channel||0,this.delta=e.delta||0,this.instrument=e.instrument,this.status=192,this.name="ProgramChangeEvent",this.data=$.numberToVariableLength(this.delta).concat(this.status|this.channel,this.instrument)},TempoEvent:C,TextEvent:D,TimeSignatureEvent:w,Track:V,TrackNameEvent:A,Utils:$,VexFlow:N,Writer:L}}();